# covid19-slack-py

## COVID-19 Slackアプリ（Python版）

本アプリは、Slack APIチュートリアル「NodeJSとSlack APIによるいまどきのネットワークプログラミング」の中で用いた全ての要素部品を組み合わせて、対象国の新型コロナウィルスの感染状況を、Slack上でテキスト、表、画像から構成されるレポートをPDFファイル形式として出力する。
同じ機能をPythonに移植したものである。

### 主な搭載機能

- 選択メニューを用いて、対象となる国を約200ヶ国の中から選択する
- 対象国の情報と感染状況を出力する
- 感染者数と死亡者数の履歴をCSVファイルで出力する
- 30日間の感染者数と死亡者数の推移をグラフ表示する
- モーダルビューを通してコメントを登録する
- 国の情報、感染状況、グラフ画像、注釈を一つのPDFファイルとして出力する
- 英語表記の国名を日本語表記に変換する

### 必要なパッケージをインストールする

コマンドライン上で次のコマンドを起動し、依存するPythonパッケージをインストールする。

```bash
pip install -r requirements.txt
```

### 環境変数を設定する

本アプリを起動するには環境変数の設定が必要である。env.tplファイルを環境変数設定ファイル.envとしてコピーし、以下の環境変数を定義する。

```bash
copy env.tpl .env
```

|  変数名  |  説明  |
| ---- | ---- |
| SLACK_BOT_TOKEN | Botユーザーとして関連付けられたトークン。対象Slackワークスペースのアプリ設定 > [OAuth & Permissions] > [Bot User OAuth Token]から取得する。xoxb-で始まる文字列。 |
| SLACK_APP_TOKEN | 全ての組織を横断できるアプリレベルトークン。対象Slackワークスペースのアプリ設定 > [Basic Information] > [App-Level Tokens]から取得する。xapp-で始まる文字列。 |
| BASE_URL | 新型コロナウィルス感染者情報を提供するWebサイト（REST API）のURL。変更不可。 |
| NUM_OF_MENU_ITEMS  | 選択メニューの項目数。 |
| DB_URL | PostgreSQLのデータベース接続先URL（下記参照）。 |
| LOCAL_FOLDER | Slackにアップロードしたファイルを暫定的に保存するローカルフォルダーの名前 |
| PY_ENV | production（本番環境）あるいはdevelopment（開発環境） |

#### 環境変数 DB_URLについて

PostgreSQLのデータベース接続先URLを設定する。このデータベースは、英語表記の国名を日本語表記に変換するテーブル(countries)と国ごとにコメントを格納するテーブル(annotation)を含む。
接続先URLは、次の形式で定義する。

```bash
postgres://<ユーザー名>:<パスワード>@<サーバー名>:<ポート番号>/<データベース名>
```

この環境変数を設定していなければ、国名の日本語変換とコメント登録をしない。

### アプリを起動する

```bash
python ./app.py
```

Slackアプリをインストールしたチャネルのメッセージ欄に以下の「スラッシュコマンド」を入力し、送信する。

#### スラッシュコマンド

- /covid19 <国名 オプション>
  指定した国の感染状況を表形式で表示する。国名を指定しなければ約200ヶ国からなる選択メニューの中から選択させ、テキスト、画像、PDFファイルで内容を提示する。
  - 該当国の感染状況の下に[全世界]、[推移グラフ]、[レポート作成]などボタンが配置されている。
- /hello
  時刻に応じた挨拶文を返答し、直近の日本の新規感染者数をグラフで表示する。
- /translate <国名>
  指定した国名（英語表記）を日本語表記に変換する。
  - DB_URLを設定しているときに動作する。

### 制限・未対応

1. 画像ファイルに表示される線グラフのスムージングに未対応。
1. PDFファイルに出力するコメントは2ページ目のみに対応する。
1. PDFファイルに出力するコメントは改行せずに表からはみ出す。
1. 新型コロナウィルス感染者情報を提供するWebサイトは、2023年3月でサービスを終了。

### 更新履歴

- 2025-07-30 dotenvを利用、DB_URLが設定されていないときの処理
- 2023-12-13 Python 3.11.xへの対応
- 2023-04-07 国名翻訳処理の向上
- 2022-10-27 初版
